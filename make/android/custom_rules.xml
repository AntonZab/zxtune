<?xml version="1.0" encoding="UTF-8"?>
<project name="build_rules">
  <!-- default properties -->
  <property name="cpu.cores" value="1" />
  <property name="native.libs.source.dir" value="jni" />
  
  <property file="${top.dir}/make/android/build.properties" />

  <macrodef name="buildlib-helper">
    <attribute name="arch" />
    <sequential>
      <exec executable="make" failonerror="true">
        <arg value="release=1" />
        <arg value="platform=android" />
        <arg value="arch=@{arch}" />
        <arg value="-C" />
        <arg value="${native.libs.source.dir}" />
        <arg value="-j" />
        <arg value="${cpu.cores}" />
      </exec>
    </sequential>
  </macrodef>
  
  <macrodef name="installib-helper">
    <attribute name="arch" />
    <sequential>
      <copy file="${top.dir}/bin/android_@{arch}/release/lib${native.libs}.so" todir="${native.libs.absolute.dir}/@{arch}" />
    </sequential>
  </macrodef>
  
  <macrodef name="makelib-helper">
    <attribute name="arch" />
    <sequential>
      <echo level="info">Make native library for arch @{arch}</echo>
      <buildlib-helper arch="@{arch}" />
      <installib-helper arch="@{arch}" />
    </sequential>
  </macrodef>
  
  <macrodef name="instsupp-helper">
    <attribute name="version" />
    <sequential>
      <echo level="info">Add support library version @{version}</echo>
      <copy file="${sdk.dir}/extras/android/support/v@{version}/android-support-v@{version}.jar" todir="${jar.libs.absolute.dir}" />
    </sequential>
  </macrodef>

  <target name="svnupdate">
    <exec executable="svn">
      <arg value="up" />
      <arg value="${top.dir}" />
    </exec>
  </target>
  
  <target name="svnrevision">
    <exec executable="svnversion" outputproperty="svn.revision">
      <arg value="${top.dir}"/>
    </exec>
    <script language="javascript">
      var rev = project.getProperty("svn.revision");
      project.setProperty("svn.revision.base", parseInt(rev));
    </script>
    <echo level="info">Current svn revision is ${svn.revision} (${svn.revision.base})</echo>
  </target>
  
  <target name="injectrevision" depends="svnrevision">
    <copy file="${top.dir}/make/android/version.tmpl" tofile="res/values/version.xml" overwrite="yes" >
      <filterset>
        <filter token="svn.revision.base" value="${svn.revision.base}" />
        <filter token="svn.revision" value="${svn.revision}" />
      </filterset>
    </copy>
  </target>
  
  <target name="nativelibs">
    <makelib-helper arch="x86" />
    <makelib-helper arch="armeabi" />
    <makelib-helper arch="armeabi-v7a" />
  </target>
  
  <target name="extralibs">
    <if>
      <condition><isset property="libs.support.version"/></condition>
      <then>
        <instsupp-helper version="${libs.support.version}" />
      </then>
    </if>
    <path id="project.all.jars.path">
      <fileset dir="${jar.libs.absolute.dir}">
        <include name="*.jar"/>
      </fileset>
    </path>
  </target>
  
  <target name="-post-compile" depends="nativelibs" />

  <target name="-pre-build" depends="injectrevision, extralibs" />
  
  <!-- Single public build target -->
  <target name="public-build" depends="svnupdate, svnrevision, release">
    <property name="build.result" value="${builds.dir}/Revision${svn.revision}_android/${ant.project.name}_r${svn.revision}.apk" />
    <delete file="${build.result}" />
    <copy file="${out.final.file}" toFile="${build.result}" />
  </target>
</project>
